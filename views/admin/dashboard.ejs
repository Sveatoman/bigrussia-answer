<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Äî BigRussiaAnswer</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="/css/notifications.css">
</head>
<body>
  <div class="noise"></div>
  
  <header>
    <nav class="navbar">
      <a href="/" class="logo">
        <span class="logo-white">BigRussia</span><span class="logo-blue">Answer</span>
      </a>
      
      <ul class="nav-links">
        <li><a href="/admin">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a></li>
      </ul>
      
      <div class="nav-actions">
        <span style="color: var(--text-gray); margin-right: 16px;">üëë <%= session.name %></span>
        <a href="/logout" class="btn-secondary">–í—ã—Ö–æ–¥</a>
      </div>
    </nav>
  </header>

  <main class="admin-container">
    <div class="container">
      <div class="admin-header">
        <h1>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h1>
      </div>

      <div class="admin-stats" id="adminStats">
        <div class="admin-stat-card">
          <div class="stat-icon">üë•</div>
          <div class="stat-value" id="activeUsers">-</div>
          <div class="stat-label">–û–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
        </div>
        
        <div class="admin-stat-card">
          <div class="stat-icon">‚è≥</div>
          <div class="stat-value" id="pendingUsers">-</div>
          <div class="stat-label">–û–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è</div>
        </div>
        
        <div class="admin-stat-card">
          <div class="stat-icon">üìã</div>
          <div class="stat-value" id="activeTasks">-</div>
          <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>
        </div>
        
        <div class="admin-stat-card">
          <div class="stat-icon">üí∞</div>
          <div class="stat-value" id="todayPayouts">-</div>
          <div class="stat-label">–í—ã–ø–ª–∞—Ç –∑–∞ —Å—É—Ç–∫–∏ (‚ÇΩ)</div>
        </div>
        
        <div class="admin-stat-card">
          <div class="stat-icon">üìù</div>
          <div class="stat-value" id="pendingSubmissions">-</div>
          <div class="stat-label">–ó–∞–¥–∞–Ω–∏–π –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</div>
        </div>
      </div>

      <div class="admin-section">
        <h2>üë• –ú–æ–¥–µ—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h2>
        <table class="tasks-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>–ò–º—è</th>
              <th>Email</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–ë–∞–ª–∞–Ω—Å</th>
              <th>–ó–∞–¥–∞–Ω–∏–π</th>
              <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="usersTableBody">
            <!-- Users will be loaded here -->
          </tbody>
        </table>
      </div>

      <div class="admin-section">
        <h2>‚è≥ –ú–æ–¥–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</h2>
        <div class="submissions-list" id="submissionsList">
          <!-- Submissions will be loaded here -->
        </div>
      </div>

      <div class="admin-section">
        <h2>üë• –ú–æ–¥–µ—Ä–∞—Ü–∏—è —Ä–∞–±–æ—á–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤</h2>
        <div class="dashboard-tabs" style="margin-bottom: 24px; border-bottom: 1px solid var(--border-subtle);">
          <button class="tab-btn active" onclick="loadWorkAccountsByStatus('pending')" style="background: transparent; border: none; color: var(--text-gray); padding: 12px 24px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s;" data-status="pending">–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</button>
          <button class="tab-btn" onclick="loadWorkAccountsByStatus('approved')" style="background: transparent; border: none; color: var(--text-gray); padding: 12px 24px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s;" data-status="approved">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</button>
          <button class="tab-btn" onclick="loadWorkAccountsByStatus('rejected')" style="background: transparent; border: none; color: var(--text-gray); padding: 12px 24px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s;" data-status="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</button>
        </div>
        <div class="submissions-list" id="workAccountsList">
          <!-- Work accounts will be loaded here -->
        </div>
      </div>

      <div class="admin-section">
        <h2>‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ –∑–∞–¥–∞–Ω–∏–µ</h2>
        <form class="task-form" id="createTaskForm">
          <div class="form-group">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>
            <input type="text" name="title" required placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤ –Ω–∞ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö">
          </div>
          
          <div class="form-group">
            <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
            <textarea name="description" required placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è"></textarea>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label>–ù–∞–≥—Ä–∞–¥–∞ (‚ÇΩ)</label>
              <input type="number" name="reward" required min="10" max="500" placeholder="25">
            </div>
            
            <div class="form-group">
              <label>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
              <input type="text" name="time_estimate" required placeholder="10‚Äì15 –º–∏–Ω—É—Ç">
            </div>
          </div>
          
          <div class="form-group">
            <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç</label>
            <input type="number" name="total_slots" required min="1" max="1000" placeholder="50">
          </div>
          
          <div class="form-group">
            <label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</label>
            <textarea name="instructions" required placeholder="–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é –∑–∞–¥–∞–Ω–∏—è"></textarea>
          </div>
          
          <button type="submit" class="btn-primary">–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
        </form>
      </div>

      <div class="admin-section">
        <h2>üìã –í—Å–µ –∑–∞–¥–∞–Ω–∏—è</h2>
        <table class="tasks-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
              <th>–ù–∞–≥—Ä–∞–¥–∞</th>
              <th>–ú–µ—Å—Ç</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="tasksTableBody">
            <!-- Tasks will be loaded here -->
          </tbody>
        </table>
      </div>

      <div class="admin-section">
        <h2>üí∞ –ó–∞—è–≤–∫–∏ –Ω–∞ –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h2>
        <div id="withdrawalsList">
          <!-- Withdrawals will be loaded here -->
        </div>
      </div>
    </div>
  </main>

  <!-- Reject Modal -->
  <div class="modal" id="rejectModal">
    <div class="modal-content">
      <h3>–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
      <textarea id="rejectComment" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è..."></textarea>
      <div class="modal-actions">
        <button class="btn-secondary" onclick="closeRejectModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-reject" onclick="confirmReject()">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- Edit Task Modal -->
  <div class="modal" id="editTaskModal">
    <div class="modal-content" style="max-width: 700px;">
      <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
      <form class="task-form" id="editTaskForm">
        <input type="hidden" id="editTaskId">
        
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è</label>
          <input type="text" id="editTitle" name="title" required>
        </div>
        
        <div class="form-group">
          <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea id="editDescription" name="description" required></textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>–ù–∞–≥—Ä–∞–¥–∞ (‚ÇΩ)</label>
            <input type="number" id="editReward" name="reward" required min="10" max="500">
          </div>
          
          <div class="form-group">
            <label>–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</label>
            <input type="text" id="editTimeEstimate" name="time_estimate" required>
          </div>
        </div>
        
        <div class="form-group">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç</label>
          <input type="number" id="editTotalSlots" name="total_slots" required min="1" max="1000">
        </div>
        
        <div class="form-group">
          <label>–°—Ç–∞—Ç—É—Å</label>
          <select id="editStatus" name="status" required>
            <option value="active">–ê–∫—Ç–∏–≤–Ω–æ</option>
            <option value="inactive">–ù–µ–∞–∫—Ç–∏–≤–Ω–æ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–π</label>
          <textarea id="editInstructions" name="instructions" required></textarea>
        </div>
        
        <div class="modal-actions">
          <button type="button" class="btn-secondary" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
          <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/js/notifications.js"></script>
  <script>
    let currentRejectId = null;

    // Helper function to render proof images
    function renderProofImages(proofImageData) {
      try {
        const images = JSON.parse(proofImageData);
        if (!Array.isArray(images) || images.length === 0) {
          return '<p style="color: var(--text-gray); font-size: 14px;">–°–∫—Ä–∏–Ω—à–æ—Ç—ã –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã</p>';
        }
        
        return `
          <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px;">
            ${images.map(img => `
              <div style="position: relative; width: 150px; height: 150px; border-radius: 8px; overflow: hidden; border: 1px solid var(--border-subtle); cursor: pointer;" onclick="window.open('/uploads/${img}', '_blank')">
                <img src="/uploads/${img}" style="width: 100%; height: 100%; object-fit: cover;" alt="Proof">
              </div>
            `).join('')}
          </div>
        `;
      } catch (e) {
        // Fallback for old single image format
        return `<img src="/uploads/${proofImageData}" class="proof-image" alt="Proof" onclick="window.open('/uploads/${proofImageData}', '_blank')">`;
      }
    }

    // Load stats
    async function loadStats() {
      try {
        const response = await fetch('/api/admin/stats');
        const stats = await response.json();
        
        document.getElementById('activeUsers').textContent = stats.activeUsers.toLocaleString();
        document.getElementById('pendingUsers').textContent = stats.pendingUsers.toLocaleString();
        document.getElementById('activeTasks').textContent = stats.activeTasks.toLocaleString();
        document.getElementById('todayPayouts').textContent = stats.todayPayouts.toLocaleString();
        document.getElementById('pendingSubmissions').textContent = stats.pendingSubmissions.toLocaleString();
      } catch (error) {
        console.error('Error loading stats:', error);
      }
    }

    // Load submissions
    async function loadSubmissions() {
      try {
        const response = await fetch('/api/admin/submissions');
        const submissions = await response.json();
        
        const list = document.getElementById('submissionsList');
        
        if (submissions.length === 0) {
          list.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</p>';
          return;
        }
        
        list.innerHTML = submissions.map(sub => `
          <div class="submission-card">
            <div class="submission-header">
              <div class="submission-info">
                <h3>${sub.task_title}</h3>
                <div class="submission-meta">üë§ ${sub.user_name} (${sub.user_email})</div>
                <div class="submission-meta">üìÖ ${new Date(sub.submitted_at).toLocaleString('ru-RU')}</div>
              </div>
              <div class="submission-reward">+${sub.reward} ‚ÇΩ</div>
            </div>
            
            <div class="submission-proof">
              <h4>–î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</h4>
              <p>${sub.proof_text || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
              ${sub.proof_image ? renderProofImages(sub.proof_image) : '<p style="color: var(--text-gray); font-size: 14px;">–°–∫—Ä–∏–Ω—à–æ—Ç—ã –Ω–µ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω—ã</p>'}
            </div>
            
            <div class="submission-actions">
              <button class="btn-approve" onclick="approveSubmission(${sub.id})">‚úì –û–¥–æ–±—Ä–∏—Ç—å</button>
              <button class="btn-reject" onclick="openRejectModal(${sub.id})">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading submissions:', error);
      }
    }

    // Approve submission
    async function approveSubmission(id) {
      if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è?')) return;
      
      try {
        const response = await fetch(`/api/admin/submissions/${id}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showSuccess('–ó–∞–¥–∞–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–æ, –Ω–∞–≥—Ä–∞–¥–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∞!');
          setTimeout(() => {
            loadSubmissions();
            loadStats();
          }, 1000);
        } else {
          console.error('Error response:', data);
          showError('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      } catch (error) {
        console.error('Fetch error:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏: ' + error.message);
      }
    }

    // Reject modal
    function openRejectModal(id) {
      currentRejectId = id;
      document.getElementById('rejectModal').classList.add('active');
    }

    function closeRejectModal() {
      currentRejectId = null;
      currentRejectAccountId = null;
      document.getElementById('rejectModal').classList.remove('active');
      document.getElementById('rejectComment').value = '';
    }

    async function confirmReject() {
      const comment = document.getElementById('rejectComment').value;
      
      if (!comment.trim()) {
        showWarning('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è');
        return;
      }
      
      try {
        const response = await fetch(`/api/admin/submissions/${currentRejectId}/reject`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ comment })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showSuccess('–ó–∞–¥–∞–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ');
          closeRejectModal();
          setTimeout(() => {
            loadSubmissions();
            loadStats();
          }, 1000);
        } else {
          console.error('Error response:', data);
          showError('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      } catch (error) {
        console.error('Fetch error:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏: ' + error.message);
      }
    }

    // Create task
    document.getElementById('createTaskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      try {
        const response = await fetch('/api/admin/tasks', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showSuccess('–ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ!');
          e.target.reset();
          setTimeout(() => {
            loadTasks();
            loadStats();
          }, 1000);
        }
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è');
      }
    });

    // Load all tasks
    async function loadTasks() {
      try {
        const response = await fetch('/api/admin/tasks');
        const tasks = await response.json();
        
        const tbody = document.getElementById('tasksTableBody');
        tbody.innerHTML = tasks.map(task => `
          <tr>
            <td>${task.id}</td>
            <td>${task.title}</td>
            <td>${task.reward} ‚ÇΩ</td>
            <td>${task.remaining_slots} / ${task.total_slots}</td>
            <td><span class="badge ${task.status}">${task.status === 'active' ? '–ê–∫—Ç–∏–≤–Ω–æ' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–æ'}</span></td>
            <td>
              <button class="btn-secondary btn-small" onclick="editTask(${task.id})" style="margin-right: 8px;">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
              <button class="btn-reject btn-small" onclick="deleteTask(${task.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading tasks:', error);
      }
    }

    // Edit task
    async function editTask(taskId) {
      try {
        const response = await fetch(`/api/admin/task/${taskId}`);
        const task = await response.json();
        
        document.getElementById('editTaskId').value = task.id;
        document.getElementById('editTitle').value = task.title;
        document.getElementById('editDescription').value = task.description;
        document.getElementById('editReward').value = task.reward;
        document.getElementById('editTimeEstimate').value = task.time_estimate;
        document.getElementById('editTotalSlots').value = task.total_slots;
        document.getElementById('editStatus').value = task.status;
        document.getElementById('editInstructions').value = task.instructions;
        
        document.getElementById('editTaskModal').classList.add('active');
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∑–∞–¥–∞–Ω–∏—è');
      }
    }

    function closeEditModal() {
      document.getElementById('editTaskModal').classList.remove('active');
    }

    document.getElementById('editTaskForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const taskId = document.getElementById('editTaskId').value;
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      console.log('Submitting task update:', taskId, data);
      
      try {
        const response = await fetch(`/api/admin/tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          showSuccess('–ó–∞–¥–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!');
          closeEditModal();
          setTimeout(() => {
            loadTasks();
            loadStats();
          }, 1000);
        } else {
          console.error('Error response:', result);
          showError('–û—à–∏–±–∫–∞: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      } catch (error) {
        console.error('Fetch error:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
      }
    });

    // Delete task
    async function deleteTask(taskId) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ?')) return;
      
      console.log('Deleting task:', taskId);
      
      try {
        const response = await fetch(`/api/admin/tasks/${taskId}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
          showSuccess('–ó–∞–¥–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ!');
          setTimeout(() => {
            loadTasks();
            loadStats();
          }, 1000);
        } else {
          console.error('Error response:', result);
          showWarning(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        }
      } catch (error) {
        console.error('Fetch error:', error);
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–¥–∞–Ω–∏—è: ' + error.message);
      }
    }

    // Load users
    async function loadUsers() {
      try {
        const response = await fetch('/api/admin/users');
        const users = await response.json();
        
        const tbody = document.getElementById('usersTableBody');
        tbody.innerHTML = users.map(user => `
          <tr>
            <td>${user.id}</td>
            <td>${user.name}</td>
            <td>${user.email}</td>
            <td><span class="badge ${user.account_status === 'approved' ? 'active' : user.account_status === 'pending' ? 'pending' : 'inactive'}">${getAccountStatusText(user.account_status)}</span></td>
            <td>${user.balance.toFixed(2)} ‚ÇΩ</td>
            <td>${user.tasks_completed}</td>
            <td>${new Date(user.created_at).toLocaleDateString('ru-RU')}</td>
            <td>
              ${user.account_status === 'pending' ? `
                <button class="btn-approve btn-small" onclick="approveUser(${user.id})" style="margin-right: 8px;">‚úì –û–¥–æ–±—Ä–∏—Ç—å</button>
                <button class="btn-reject btn-small" onclick="rejectUser(${user.id})">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
              ` : user.account_status === 'rejected' ? `
                <button class="btn-approve btn-small" onclick="approveUser(${user.id})" style="margin-right: 8px;">‚úì –û–¥–æ–±—Ä–∏—Ç—å</button>
                <button class="btn-reject btn-small" onclick="deleteUser(${user.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              ` : `
                <button class="btn-reject btn-small" onclick="rejectUser(${user.id})" style="margin-right: 8px;">‚úó –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                <button class="btn-reject btn-small" onclick="deleteUser(${user.id})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
              `}
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading users:', error);
      }
    }

    function getAccountStatusText(status) {
      const statuses = {
        'pending': '–û–∂–∏–¥–∞–µ—Ç',
        'approved': '–û–¥–æ–±—Ä–µ–Ω',
        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω'
      };
      return statuses[status] || status;
    }

    async function approveUser(userId) {
      if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
      
      try {
        const response = await fetch(`/api/admin/users/${userId}/approve`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showSuccess('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–¥–æ–±—Ä–µ–Ω!');
          loadUsers();
          loadStats();
        } else {
          showError('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏: ' + error.message);
      }
    }

    async function rejectUser(userId) {
      if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
      
      try {
        const response = await fetch(`/api/admin/users/${userId}/reject`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showSuccess('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–µ–Ω/–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
          loadUsers();
          loadStats();
        } else {
          showError('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏: ' + error.message);
      }
    }

    async function deleteUser(userId) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) return;
      
      try {
        const response = await fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showSuccess('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω!');
          loadUsers();
          loadStats();
        } else {
          showError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
        }
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
      }
    }

    // Load withdrawals
    async function loadWithdrawals() {
      try {
        const response = await fetch('/api/admin/withdrawals');
        const withdrawals = await response.json();
        
        const list = document.getElementById('withdrawalsList');
        
        if (withdrawals.length === 0) {
          list.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">–ù–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –≤—ã–≤–æ–¥</p>';
          return;
        }
        
        list.innerHTML = withdrawals.map(w => `
          <div class="submission-card">
            <div class="submission-header">
              <div class="submission-info">
                <h3>${w.amount} ‚ÇΩ ‚Äî ${getMethodName(w.method)}</h3>
                <div class="submission-meta">üë§ ${w.user_name} (${w.user_email})</div>
                <div class="submission-meta">üìÖ ${new Date(w.created_at).toLocaleString('ru-RU')}</div>
                <div class="submission-meta">üí≥ –†–µ–∫–≤–∏–∑–∏—Ç—ã: ${w.details}</div>
              </div>
              <span class="task-status ${w.status}">${getWithdrawalStatusText(w.status)}</span>
            </div>
            
            ${w.status === 'pending' ? `
              <div class="submission-actions">
                <button class="btn-approve" onclick="approveWithdrawal(${w.id})">‚úì –í—ã–ø–ª–∞—Ç–∏—Ç—å</button>
                <button class="btn-reject" onclick="rejectWithdrawal(${w.id})">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
              </div>
            ` : ''}
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading withdrawals:', error);
      }
    }

    function getMethodName(method) {
      const methods = {
        'card': '–ö–∞—Ä—Ç–∞ –†–§',
        'sbp': '–°–ë–ü',
        'yoomoney': '–ÆMoney'
      };
      return methods[method] || method;
    }

    function getWithdrawalStatusText(status) {
      const statuses = {
        'pending': '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ',
        'approved': '–í—ã–ø–ª–∞—á–µ–Ω–æ',
        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'
      };
      return statuses[status] || status;
    }

    async function approveWithdrawal(id) {
      if (!confirm('–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤—ã–ø–ª–∞—Ç—É?')) return;
      
      try {
        const response = await fetch(`/api/admin/withdrawals/${id}/approve`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showSuccess('–í—ã–ø–ª–∞—Ç–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!');
          setTimeout(() => {
            loadWithdrawals();
            loadStats();
          }, 1000);
        }
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –≤—ã–ø–ª–∞—Ç—ã');
      }
    }

    async function rejectWithdrawal(id) {
      if (!confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≤—ã–≤–æ–¥? –°—Ä–µ–¥—Å—Ç–≤–∞ –≤–µ—Ä–Ω—É—Ç—Å—è –Ω–∞ –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.')) return;
      
      try {
        const response = await fetch(`/api/admin/withdrawals/${id}/reject`, {
          method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
          showSuccess('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞, —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –±–∞–ª–∞–Ω—Å');
          setTimeout(() => {
            loadWithdrawals();
            loadStats();
          }, 1000);
        }
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏');
      }
    }

    // Initial load
    loadStats();
    loadSubmissions();
    loadTasks();
    loadWithdrawals();
    loadWorkAccountsByStatus('pending');

    // Load work accounts by status
    let currentAccountStatus = 'pending';
    
    async function loadWorkAccountsByStatus(status) {
      currentAccountStatus = status;
      
      // Update active tab
      document.querySelectorAll('[data-status]').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.status === status) {
          btn.classList.add('active');
        }
      });
      
      try {
        const response = await fetch(`/api/admin/work-accounts?status=${status}`);
        const accounts = await response.json();
        
        const list = document.getElementById('workAccountsList');
        
        if (accounts.length === 0) {
          list.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–æ–≤ –≤ —ç—Ç–æ–º —Å—Ç–∞—Ç—É—Å–µ</p>';
          return;
        }
        
        list.innerHTML = accounts.map(acc => `
          <div class="submission-card">
            <div class="submission-header">
              <div class="submission-info">
                <h3>${acc.platform} ‚Äî ${acc.account_name}</h3>
                <div class="submission-meta">üë§ ${acc.user_name} (${acc.user_email})</div>
                <div class="submission-meta">üìÖ ${new Date(acc.created_at).toLocaleString('ru-RU')}</div>
                <div class="submission-meta">üîó <a href="${acc.account_link}" target="_blank" style="color: var(--primary-blue);">–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a></div>
              </div>
              <span class="task-status ${acc.status}">${getAccountStatusText(acc.status)}</span>
            </div>
            
            ${acc.proof_text ? `
              <div class="submission-proof">
                <h4>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</h4>
                <p>${acc.proof_text}</p>
              </div>
            ` : ''}
            
            ${acc.screenshot ? `
              <div style="margin: 16px 0;">
                <h4 style="font-size: 14px; color: var(--text-gray); margin-bottom: 8px;">–°–∫—Ä–∏–Ω—à–æ—Ç –ø—Ä–æ—Ñ–∏–ª—è:</h4>
                <img src="/uploads/${acc.screenshot}" class="proof-image" alt="Screenshot" onclick="window.open('/uploads/${acc.screenshot}', '_blank')">
              </div>
            ` : ''}
            
            ${acc.admin_comment ? `
              <div class="admin-comment">
                <strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞:</strong><br>${acc.admin_comment}
              </div>
            ` : ''}
            
            ${acc.status === 'pending' ? `
              <div class="submission-actions">
                <button class="btn-approve" onclick="approveWorkAccount(${acc.id})">‚úì –û–¥–æ–±—Ä–∏—Ç—å</button>
                <button class="btn-reject" onclick="openRejectAccountModal(${acc.id})">‚úó –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
              </div>
            ` : ''}
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading work accounts:', error);
      }
    }

    function getAccountStatusText(status) {
      const statuses = {
        'pending': '–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ',
        'approved': '–û–¥–æ–±—Ä–µ–Ω',
        'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω'
      };
      return statuses[status] || status;
    }

    async function approveWorkAccount(accountId) {
      if (!confirm('–û–¥–æ–±—Ä–∏—Ç—å —ç—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç?')) return;
      
      try {
        const response = await fetch(`/api/admin/work-accounts/${accountId}/approve`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
          showSuccess('–ê–∫–∫–∞—É–Ω—Ç –æ–¥–æ–±—Ä–µ–Ω!');
          setTimeout(() => loadWorkAccountsByStatus(currentAccountStatus), 1000);
        } else {
          showError('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏: ' + error.message);
      }
    }

    let currentRejectAccountId = null;

    function openRejectAccountModal(accountId) {
      currentRejectAccountId = accountId;
      document.getElementById('rejectComment').value = '';
      document.getElementById('rejectModal').classList.add('active');
    }

    // Auto-refresh every 30 seconds
    setInterval(() => {
      loadStats();
      loadSubmissions();
      loadWithdrawals();
      loadWorkAccountsByStatus(currentAccountStatus);
    }, 30000);
  </script>
</body>
</html>
