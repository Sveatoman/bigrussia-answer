<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ ‚Äî YanFarm</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/dashboard.css">
  <link rel="stylesheet" href="/css/notifications.css">
</head>
<body>
  <div class="noise"></div>
  
  <header>
    <nav class="navbar">
      <a href="/" class="logo">
        <span class="logo-white">Yan</span><span class="logo-blue">Farm</span>
      </a>
      
      <ul class="nav-links">
        <li><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
        <li><a href="/#tasks">–ó–∞–¥–∞–Ω–∏—è</a></li>
        <% if (user) { %>
          <li><a href="/dashboard">–ö–∞–±–∏–Ω–µ—Ç</a></li>
        <% } %>
      </ul>
      
      <div class="nav-actions">
        <% if (user) { %>
          <span style="color: var(--text-gray); margin-right: 16px;"><%= user.name %></span>
          <a href="/logout" class="btn-secondary" style="text-decoration: none;">–í—ã—Ö–æ–¥</a>
        <% } else { %>
          <a href="/login" class="btn-secondary">–í–æ–π—Ç–∏</a>
          <a href="/register" class="btn-primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        <% } %>
      </div>
    </nav>
  </header>

  <main class="dashboard-container">
    <div class="container">
      <div class="dashboard-header">
        <h1>üíº –ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h1>
        <p>–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –Ω–∞ –∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏—è—Ö!</p>
      </div>

      <% if (user) { %>
        <!-- Referral Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">–í–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥</div>
            <div class="stat-value" style="font-size: 28px; color: var(--primary-blue);"><%= user.referral_code %></div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">–ü—Ä–∏–≥–ª–∞—à–µ–Ω–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
            <div class="stat-value"><%= user.referrals_count || 0 %></div>
          </div>
          
          <div class="stat-card">
            <div class="stat-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ —Å —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤</div>
            <div class="stat-value earned"><%= (user.referral_earnings || 0).toFixed(2) %> ‚ÇΩ</div>
          </div>
        </div>

        <!-- Referral Link -->
        <div class="auth-card" style="margin-bottom: 32px;">
          <h3 style="margin-bottom: 16px;">üîó –í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</h3>
          <p style="color: var(--text-gray); margin-bottom: 16px;">
            –û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º. –ö–æ–≥–¥–∞ –æ–Ω–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é—Ç—Å—è –∏ –≤—ã–ø–æ–ª–Ω—è—Ç –∑–∞–¥–∞–Ω–∏–µ, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ!
          </p>
          
          <div style="display: flex; gap: 12px; align-items: center;">
            <input 
              type="text" 
              id="referralLink" 
              value="<%= referralLink %>" 
              readonly 
              style="flex: 1; background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-subtle); border-radius: 12px; padding: 14px 16px; color: var(--text-light); font-size: 14px;"
            >
            <button onclick="copyReferralLink()" class="btn-primary" style="white-space: nowrap;">
              üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
        </div>

        <!-- How it works -->
        <div class="auth-card" style="margin-bottom: 32px;">
          <h3 style="margin-bottom: 16px;">üìñ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?</h3>
          
          <div style="display: flex; flex-direction: column; gap: 20px;">
            <div style="display: flex; gap: 16px;">
              <div style="flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; background: rgba(47, 128, 255, 0.1); display: flex; align-items: center; justify-content: center; color: var(--primary-blue); font-weight: 700; font-size: 18px;">1</div>
              <div>
                <div style="font-weight: 600; margin-bottom: 4px;">–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π</div>
                <div style="color: var(--text-gray); font-size: 14px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à—É —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É –¥—Ä—É–∑—å—è–º, –≤ —Å–æ—Ü—Å–µ—Ç–∏ –∏–ª–∏ –Ω–∞ —Ñ–æ—Ä—É–º—ã</div>
              </div>
            </div>

            <div style="display: flex; gap: 16px;">
              <div style="flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; background: rgba(47, 128, 255, 0.1); display: flex; align-items: center; justify-content: center; color: var(--primary-blue); font-weight: 700; font-size: 18px;">2</div>
              <div>
                <div style="font-weight: 600; margin-bottom: 4px;">–î—Ä—É–≥ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è</div>
                <div style="color: var(--text-gray); font-size: 14px;">–í–∞—à –¥—Ä—É–≥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ –∏ —Å–æ–∑–¥–∞—ë—Ç –∞–∫–∫–∞—É–Ω—Ç –Ω–∞ YanFarm</div>
              </div>
            </div>

            <div style="display: flex; gap: 16px;">
              <div style="flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; background: rgba(47, 128, 255, 0.1); display: flex; align-items: center; justify-content: center; color: var(--primary-blue); font-weight: 700; font-size: 18px;">3</div>
              <div>
                <div style="font-weight: 600; margin-bottom: 4px;">–î—Ä—É–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞–Ω–∏—è</div>
                <div style="color: var(--text-gray); font-size: 14px;">–ö–æ–≥–¥–∞ –≤–∞—à —Ä–µ—Ñ–µ—Ä–∞–ª –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–¥–∞–Ω–∏–µ, –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –Ω–∞–≥—Ä–∞–¥—ã</div>
              </div>
            </div>

            <div style="display: flex; gap: 16px;">
              <div style="flex-shrink: 0; width: 40px; height: 40px; border-radius: 50%; background: rgba(39, 174, 96, 0.1); display: flex; align-items: center; justify-content: center; color: var(--success-green); font-weight: 700; font-size: 18px;">‚úì</div>
              <div>
                <div style="font-weight: 600; margin-bottom: 4px; color: var(--success-green);">–ü–æ–ª—É—á–∞–π—Ç–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ</div>
                <div style="color: var(--text-gray); font-size: 14px;">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Referral List -->
        <div class="auth-card">
          <h3 style="margin-bottom: 24px;">üë• –í–∞—à–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—ã</h3>
          <div id="referralsList">
            <!-- Will be loaded via JavaScript -->
          </div>
        </div>

      <% } else { %>
        <!-- Not logged in -->
        <div class="auth-card" style="text-align: center; padding: 60px 40px;">
          <h2 style="margin-bottom: 16px;">–í–æ–π–¥–∏—Ç–µ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é —Å—Å—ã–ª–∫—É</h2>
          <p style="color: var(--text-gray); margin-bottom: 32px;">
            –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∏–ª–∏ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–∞ –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º–µ
          </p>
          <div style="display: flex; gap: 16px; justify-content: center;">
            <a href="/register" class="btn-primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
            <a href="/login" class="btn-secondary">–í–æ–π—Ç–∏</a>
          </div>
        </div>
      <% } %>
    </div>
  </main>

  <footer style="background: rgba(10, 15, 24, 0.8); backdrop-filter: blur(10px); border-top: 1px solid var(--border-subtle); padding: 32px 0; margin-top: 80px;">
    <div class="container" style="text-align: center;">
      <div style="margin-bottom: 16px;">
        <a href="https://t.me/yanfarm_support" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: rgba(47, 128, 255, 0.1); border: 1px solid var(--primary-blue); border-radius: 12px; color: var(--primary-blue); text-decoration: none; transition: all 0.3s;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.781-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.752-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635.099-.002.321.023.465.141.121.099.155.232.171.326.016.094.036.308.02.475z"/>
          </svg>
          üí¨ –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞
        </a>
      </div>
      <div style="color: var(--text-gray); font-size: 14px;">
        <p style="margin: 8px 0;">–ë–∏—Ä–∂–∞ –º–∏–∫—Ä–æ–∑–∞–¥–∞–Ω–∏–π –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞</p>
        <p style="margin: 8px 0; opacity: 0.7;">¬© 2024 YanFarm. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
      </div>
    </div>
  </footer>

  <script src="/js/notifications.js"></script>
  <script>
    function copyReferralLink() {
      const input = document.getElementById('referralLink');
      input.select();
      input.setSelectionRange(0, 99999); // For mobile
      
      try {
        document.execCommand('copy');
        showSuccess('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
      } catch (err) {
        // Fallback for modern browsers
        navigator.clipboard.writeText(input.value).then(() => {
          showSuccess('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        }).catch(() => {
          showError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É');
        });
      }
    }
  </script>

  <% if (user) { %>
  <script>
    // Load referrals list
    async function loadReferrals() {
      try {
        const response = await fetch('/api/my-referrals');
        const referrals = await response.json();
        
        const list = document.getElementById('referralsList');
        
        if (referrals.length === 0) {
          list.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤. –ü–æ–¥–µ–ª–∏—Ç–µ—Å—å —Å—Å—ã–ª–∫–æ–π —Å –¥—Ä—É–∑—å—è–º–∏!</p>';
          return;
        }
        
        list.innerHTML = referrals.map(ref => `
          <div style="border-bottom: 1px solid var(--border-subtle); padding: 16px 0; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-weight: 600; margin-bottom: 4px;">\${ref.name}</div>
              <div style="color: var(--text-gray); font-size: 14px;">
                –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω: \${new Date(ref.created_at).toLocaleDateString('ru-RU')}
              </div>
            </div>
            <div style="text-align: right;">
              <div style="color: var(--success-green); font-weight: 600;">\${ref.tasks_completed} –∑–∞–¥–∞–Ω–∏–π</div>
              <div style="color: var(--text-gray); font-size: 14px;">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
            </div>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading referrals:', error);
      }
    }

    loadReferrals();
  </script>
  <% } %>
</body>
</html>
