<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YanFarm ‚Äî –ë–∏—Ä–∂–∞ –º–∏–∫—Ä–æ–∑–∞–¥–∞—á</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/notifications.css">
</head>
<body>
  <div class="noise"></div>
  
  <header>
    <nav class="navbar">
      <a href="/" class="logo">
        <span class="logo-white">Yan</span><span class="logo-blue">Farm</span>
      </a>
      
      <ul class="nav-links">
        <li><a href="/">–ì–ª–∞–≤–Ω–∞—è</a></li>
        <li><a href="#tasks">–ó–∞–¥–∞–Ω–∏—è</a></li>
        <li><a href="/partners">–ü–∞—Ä—Ç–Ω—ë—Ä–∞–º</a></li>
      </ul>
      
      <div class="nav-actions">
        <% if (user) { %>
          <a href="/dashboard" class="btn-primary">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</a>
          <a href="/logout" class="btn-secondary">–í—ã—Ö–æ–¥</a>
        <% } else { %>
          <a href="/login" class="btn-secondary">–í–æ–π—Ç–∏</a>
          <a href="/register" class="btn-primary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</a>
        <% } %>
      </div>
    </nav>
  </header>

  <main>
    <section class="hero">
      <div class="container">
        <h1>
          –ë–∏—Ä–∂–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö<br>
          <span class="gradient-text">–º–∏–∫—Ä–æ–∑–∞–¥–∞—á</span> –≤ –†–æ—Å—Å–∏–∏
        </h1>
        <p>
          –í—ã–ø–æ–ª–Ω—è–π –ø—Ä–æ—Å—Ç—ã–µ –∑–∞–¥–∞–Ω–∏—è, –ø–æ–ª—É—á–∞–π —á–µ—Å—Ç–Ω—É—é –æ–ø–ª–∞—Ç—É.<br>
          –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞. –í—ã–≤–æ–¥ –æ—Ç 50 ‚ÇΩ.
        </p>
        <div class="hero-buttons">
          <a href="#tasks" class="btn-primary">–°–º–æ—Ç—Ä–µ—Ç—å –∑–∞–¥–∞–Ω–∏—è</a>
          <button onclick="showHowItWorks()" class="btn-secondary">–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç</button>
        </div>
      </div>
    </section>

    <section class="tasks-section" id="tasks">
      <div class="container">
        <h2 class="section-title">–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤</h2>

        <div class="tasks-grid" id="tasksGrid">
          <!-- Tasks will be loaded here -->
        </div>
      </div>
    </section>
  </main>

  <script src="/js/notifications.js"></script>
  <script>
    const instructionsUrl = '<%= process.env.INSTRUCTIONS_URL || "" %>';
    
    // Show how it works
    function showHowItWorks() {
      showInfo(`üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:\n\n1Ô∏è‚É£ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ\n2Ô∏è‚É£ –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞\n3Ô∏è‚É£ –í—ã–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏\n4Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å—Ç–µ –æ—Ç—á–µ—Ç —Å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏\n5Ô∏è‚É£ –î–æ–∂–¥–∏—Ç–µ—Å—å –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º\n6Ô∏è‚É£ –ü–æ–ª—É—á–∏—Ç–µ –Ω–∞–≥—Ä–∞–¥—É –Ω–∞ –±–∞–ª–∞–Ω—Å\n7Ô∏è‚É£ –í—ã–≤–æ–¥–∏—Ç–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –æ—Ç 50 ‚ÇΩ\n\nüí∞ –ß–µ—Å—Ç–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –∑–∞ –∫–∞–∂–¥–æ–µ –∑–∞–¥–∞–Ω–∏–µ!\n‚ö° –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞–º–∏!\n‚úÖ –í—ã–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É, –°–ë–ü –∏–ª–∏ –ÆMoney!`, 10000);
    }

    // Load tasks
    async function loadTasks() {
      try {
        const response = await fetch('/api/tasks');
        const tasks = await response.json();
        
        const grid = document.getElementById('tasksGrid');
        
        if (tasks.length === 0) {
          grid.innerHTML = '<p style="text-align: center; color: var(--text-gray); padding: 40px; grid-column: 1/-1;">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</p>';
          return;
        }
        
        grid.innerHTML = tasks.map(task => `
          <div class="task-card">
            <h3 class="task-title">${task.title}</h3>
            <p class="task-description">${task.description}</p>
            <div class="task-meta">
              <div class="task-reward">+${task.reward} ‚ÇΩ</div>
              <div class="task-info">
                <span>‚è± ${task.time_estimate}</span>
                <span>üë• ${task.remaining_slots} –º–µ—Å—Ç</span>
              </div>
            </div>
            <% if (user) { %>
              <button class="btn-primary" onclick="takeTask(${task.id})">–í–∑—è—Ç—å ‚Üí</button>
            <% } else { %>
              <a href="/login" class="btn-primary">–í–æ–π—Ç–∏ —á—Ç–æ–±—ã –≤–∑—è—Ç—å ‚Üí</a>
            <% } %>
          </div>
        `).join('');
      } catch (error) {
        console.error('Error loading tasks:', error);
        showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞–Ω–∏–π');
      }
    }

    async function takeTask(taskId) {
      // First, check if user has approved accounts
      try {
        const accountsResponse = await fetch('/api/available-work-accounts');
        const accounts = await accountsResponse.json();
        
        const availableAccounts = accounts.filter(acc => acc.isAvailable);
        
        if (accounts.length === 0) {
          showWarning('–£ –≤–∞—Å –Ω–µ—Ç –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö —Ä–∞–±–æ—á–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤. –î–æ–±–∞–≤—å—Ç–µ –∞–∫–∫–∞—É–Ω—Ç—ã –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.');
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 2000);
          return;
        }
        
        if (availableAccounts.length === 0) {
          const nextAvailable = accounts[0];
          showWarning(`–í—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã –≤ –∫—É–ª–¥–∞—É–Ω–µ. –°–ª–µ–¥—É—é—â–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ ${nextAvailable.cooldownHoursLeft} —á.`);
          return;
        }
        
        // Show account selection
        const accountOptions = availableAccounts.map(acc => 
          `<option value="${acc.id}">${acc.platform} - ${acc.account_name}</option>`
        ).join('');
        
        const accountSelect = `
          <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 8px; color: var(--text-gray);">–í—ã–±–µ—Ä–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:</label>
            <select id="accountSelect" style="width: 100%; padding: 10px; border-radius: 8px; background: var(--card-bg); color: var(--text-light); border: 1px solid var(--border-subtle);">
              ${accountOptions}
            </select>
            <p style="color: var(--text-gray); font-size: 13px; margin-top: 8px;">
              ‚è± –ü–æ—Å–ª–µ –≤–∑—è—Ç–∏—è –∑–∞–¥–∞–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç —É–π–¥–µ—Ç –≤ –∫—É–ª–¥–∞—É–Ω –Ω–∞ 36-48 —á–∞—Å–æ–≤
            </p>
          </div>
        `;
        
        // Create custom modal
        const modal = document.createElement('div');
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
        modal.innerHTML = `
          <div style="background: var(--card-bg); border-radius: 16px; padding: 32px; max-width: 500px; width: 90%; border: 1px solid var(--border-subtle);">
            <h3 style="margin-bottom: 16px;">–í–∑—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ</h3>
            ${accountSelect}
            <div style="display: flex; gap: 12px; margin-top: 24px;">
              <button onclick="this.closest('div').parentElement.parentElement.remove()" class="btn-secondary" style="flex: 1;">–û—Ç–º–µ–Ω–∞</button>
              <button onclick="confirmTakeTask(${taskId})" class="btn-primary" style="flex: 1;">–í–∑—è—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
        
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–∫–∫–∞—É–Ω—Ç–æ–≤');
      }
    }

    async function confirmTakeTask(taskId) {
      const accountSelect = document.getElementById('accountSelect');
      const workAccountId = accountSelect.value;
      
      // Remove modal
      accountSelect.closest('div').parentElement.parentElement.remove();
      
      try {
        const response = await fetch(`/api/tasks/${taskId}/take`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ work_account_id: workAccountId })
        });
        
        const data = await response.json();
        
        if (data.success) {
          showSuccess(`–ó–∞–¥–∞–Ω–∏–µ –≤–∑—è—Ç–æ! –ê–∫–∫–∞—É–Ω—Ç –≤ –∫—É–ª–¥–∞—É–Ω–µ –Ω–∞ ${data.cooldownHours} —á.`);
          
          // Show instructions if URL is set
          if (instructionsUrl) {
            setTimeout(() => {
              showInfo(`üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é: <a href="${instructionsUrl}" target="_blank" style="color: var(--primary-blue); text-decoration: underline;">–û—Ç–∫—Ä—ã—Ç—å</a>`, 8000);
            }, 1000);
          }
          
          setTimeout(() => {
            window.location.href = '/dashboard';
          }, 2000);
        } else {
          showError(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è');
        }
      } catch (error) {
        showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∑—è—Ç–∏–∏ –∑–∞–¥–∞–Ω–∏—è');
      }
    }

    // Load tasks on page load
    loadTasks();
  </script>

  <footer style="background: rgba(10, 15, 24, 0.8); backdrop-filter: blur(10px); border-top: 1px solid var(--border-subtle); padding: 32px 0; margin-top: 80px;">
    <div class="container" style="text-align: center;">
      <div style="margin-bottom: 16px;">
        <a href="/" class="logo" style="display: inline-block; text-decoration: none; font-size: 24px; font-weight: 700;">
          <span class="logo-white">Yan</span><span class="logo-blue">Farm</span>
        </a>
      </div>
      
      <div style="margin-bottom: 16px;">
        <a href="https://t.me/yanfarm_support" target="_blank" style="display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: rgba(47, 128, 255, 0.1); border: 1px solid var(--primary-blue); border-radius: 12px; color: var(--primary-blue); text-decoration: none; transition: all 0.3s;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.781-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.752-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635.099-.002.321.023.465.141.121.099.155.232.171.326.016.094.036.308.02.475z"/>
          </svg>
          üí¨ –¢–µ—Ö–ø–æ–¥–¥–µ—Ä–∂–∫–∞
        </a>
      </div>
      
      <div style="color: var(--text-gray); font-size: 14px;">
        <p style="margin: 8px 0;">–ë–∏—Ä–∂–∞ –º–∏–∫—Ä–æ–∑–∞–¥–∞–Ω–∏–π –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞</p>
        <p style="margin: 8px 0; opacity: 0.7;">¬© 2024 YanFarm. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
      </div>
    </div>
  </footer>
</body>
</html>
